user www-data;
pid /run/nginx.pid;
include /etc/nginx/modules-enabled/*.conf;
# target concurrent users (from services.yml): 753664
# https://www.nginx.com/blog/tuning-nginx/
worker_processes 92;
events {
    worker_connections 8192;
    multi_accept on;
}
http {
    ##
    # Basic Settings
    ##

    sendfile on;
    # minimize latency
    tcp_nodelay on;
    tcp_nopush off;
    types_hash_max_size 2048;
    server_tokens off;

    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    ##
    # SSL Settings
    ##

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    # see https://syslink.pl/cipherlist/
    ssl_dhparam /etc/nginx/dhparam.pem; # openssl dhparam -out /etc/nginx/dhparam.pem 4096
    ssl_ciphers EECDH+AESGCM:EDH+AESGCM;
    ssl_ecdh_curve secp384r1; # Requires nginx >= 1.1.0
    ssl_session_timeout  10m;
    ssl_session_cache shared:SSL:10m;
    ssl_session_tickets off; # Requires nginx >= 1.5.9
    ssl_stapling on; # Requires nginx >= 1.3.7
    ssl_stapling_verify on; # Requires nginx => 1.3.7
    resolver 1.1.1.1 1.0.0.1 valid=300s;
    resolver_timeout 5s;
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload";
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";

    ##
    # Logging Settings
    ##

    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    ##
    # Gzip Settings
    ##

    gzip on;
    upstream service-block-web {
        server warpservices:7000 weight=1;
        server warpservices:7001 weight=24;
        server warpservices:7002 weight=25;
        server warpservices:7003 weight=25;
        server warpservices:7004 weight=25;
        keepalive 1024;
        keepalive_requests 1024;
        keepalive_time 30s;
        keepalive_timeout 30s;
    }
    upstream service-block-web-beta {
        server warpservices:7000;

        keepalive 1024;
        keepalive_requests 1024;
        keepalive_time 30s;
        keepalive_timeout 30s;
    }
    upstream service-block-web-g1 {
        server warpservices:7001;

        keepalive 1024;
        keepalive_requests 1024;
        keepalive_time 30s;
        keepalive_timeout 30s;
    }
    upstream service-block-web-g2 {
        server warpservices:7002;

        keepalive 1024;
        keepalive_requests 1024;
        keepalive_time 30s;
        keepalive_timeout 30s;
    }
    upstream service-block-web-g3 {
        server warpservices:7003;

        keepalive 1024;
        keepalive_requests 1024;
        keepalive_time 30s;
        keepalive_timeout 30s;
    }
    upstream service-block-web-g4 {
        server warpservices:7004;

        keepalive 1024;
        keepalive_requests 1024;
        keepalive_time 30s;
        keepalive_timeout 30s;
    }
    # see https://www.nginx.com/blog/rate-limiting-nginx/
    limit_req_zone $binary_remote_addr zone=standardlimit:128m rate=5r/s;
    limit_req zone=standardlimit burst=50 delay=25;
    server {
        listen 80 default_server;
        server_name _;
        location / {
            deny all;
        }
    }
    server {
        listen 80;
        server_name local-lb.bringyour.com;
        location =/virgo-arkansas-mao-zircon/status {
            alias /srv/warp/status/status.json;
            add_header Content-Type application/json;
        }
        location =/breaker-gawk-sanskrit-mudd/status {
            alias /srv/warp/status/status.json;
            add_header Content-Type application/json;
        }
        location / {
            return 301 https://$host$request_uri;
        }
    }
    server {
        listen 443 ssl;
        server_name local-lb.bringyour.com;
        ssl_certificate     /srv/warp/vault/tls/2023.6.1/star.bringyour.com/star.bringyour.com.pem;
        ssl_certificate_key /srv/warp/vault/tls/2023.6.1/star.bringyour.com/star.bringyour.com.key;
        location =/virgo-arkansas-mao-zircon/status {
            alias /srv/warp/status/status.json;
            add_header Content-Type application/json;
        }
        location =/breaker-gawk-sanskrit-mudd/status {
            alias /srv/warp/status/status.json;
            add_header Content-Type application/json;
        }
        location /virgo-arkansas-mao-zircon/by/service/web/ {
            proxy_pass http://service-block-web/;
            proxy_set_header X-Forwarded-For $remote_addr;
            proxy_set_header Host local-web.bringyour.com;
        }
        location /virgo-arkansas-mao-zircon/by/b/web/beta/ {
            proxy_pass http://service-block-web-beta/;
            proxy_set_header X-Forwarded-For $remote_addr;
            proxy_set_header Host local-web.bringyour.com;
        }
        location /virgo-arkansas-mao-zircon/by/b/web/g1/ {
            proxy_pass http://service-block-web-g1/;
            proxy_set_header X-Forwarded-For $remote_addr;
            proxy_set_header Host local-web.bringyour.com;
        }
        location /virgo-arkansas-mao-zircon/by/b/web/g2/ {
            proxy_pass http://service-block-web-g2/;
            proxy_set_header X-Forwarded-For $remote_addr;
            proxy_set_header Host local-web.bringyour.com;
        }
        location /virgo-arkansas-mao-zircon/by/b/web/g3/ {
            proxy_pass http://service-block-web-g3/;
            proxy_set_header X-Forwarded-For $remote_addr;
            proxy_set_header Host local-web.bringyour.com;
        }
        location /virgo-arkansas-mao-zircon/by/b/web/g4/ {
            proxy_pass http://service-block-web-g4/;
            proxy_set_header X-Forwarded-For $remote_addr;
            proxy_set_header Host local-web.bringyour.com;
        }
        location /breaker-gawk-sanskrit-mudd/by/service/web/ {
            proxy_pass http://service-block-web/;
            proxy_set_header X-Forwarded-For $remote_addr;
            proxy_set_header Host local-web.bringyour.com;
        }
        location /breaker-gawk-sanskrit-mudd/by/b/web/beta/ {
            proxy_pass http://service-block-web-beta/;
            proxy_set_header X-Forwarded-For $remote_addr;
            proxy_set_header Host local-web.bringyour.com;
        }
        location /breaker-gawk-sanskrit-mudd/by/b/web/g1/ {
            proxy_pass http://service-block-web-g1/;
            proxy_set_header X-Forwarded-For $remote_addr;
            proxy_set_header Host local-web.bringyour.com;
        }
        location /breaker-gawk-sanskrit-mudd/by/b/web/g2/ {
            proxy_pass http://service-block-web-g2/;
            proxy_set_header X-Forwarded-For $remote_addr;
            proxy_set_header Host local-web.bringyour.com;
        }
        location /breaker-gawk-sanskrit-mudd/by/b/web/g3/ {
            proxy_pass http://service-block-web-g3/;
            proxy_set_header X-Forwarded-For $remote_addr;
            proxy_set_header Host local-web.bringyour.com;
        }
        location /breaker-gawk-sanskrit-mudd/by/b/web/g4/ {
            proxy_pass http://service-block-web-g4/;
            proxy_set_header X-Forwarded-For $remote_addr;
            proxy_set_header Host local-web.bringyour.com;
        }
    }
    server {
        listen 80;
        server_name local-web.bringyour.com;
        return 301 https://$host$request_uri;
    }
    server {
        listen 443 ssl;
        server_name local-web.bringyour.com;
        ssl_certificate     /srv/warp/vault/tls/2023.6.1/star.bringyour.com/star.bringyour.com.pem;
        ssl_certificate_key /srv/warp/vault/tls/2023.6.1/star.bringyour.com/star.bringyour.com.key;
        location =/callused-bronchus-eastern-quinine/status {
            deny all;
        }
        location /callused-bronchus-eastern-quinine/ {
            proxy_pass http://service-block-web/;
            proxy_set_header X-Forwarded-For $remote_addr;
            # see https://enable-cors.org/server_nginx.html
            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Allow-Origin' 'https://bringyour.com';
                add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
                #
                # Custom headers and headers various browsers *should* be OK with but aren't
                #
                add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,X-Client-Version';
                #
                # Tell client that this pre-flight info is valid for 20 days
                #
                add_header 'Access-Control-Max-Age' 1728000;
                add_header 'Content-Type' 'text/plain; charset=utf-8';
                add_header 'Content-Length' 0;
                return 204;
             }
             if ($request_method = 'POST') {
                add_header 'Access-Control-Allow-Origin' 'https://bringyour.com' always;
                add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
                add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,X-Client-Version' always;
                add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range' always;
             }
             if ($request_method = 'GET') {
                add_header 'Access-Control-Allow-Origin' 'https://bringyour.com' always;
                add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
                add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,X-Client-Version' always;
                add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range' always;
             }
        }
        location =/formosa-eat-rookie-trow/status {
            deny all;
        }
        location /formosa-eat-rookie-trow/ {
            proxy_pass http://service-block-web/;
            proxy_set_header X-Forwarded-For $remote_addr;
            # see https://enable-cors.org/server_nginx.html
            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Allow-Origin' 'https://bringyour.com';
                add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
                #
                # Custom headers and headers various browsers *should* be OK with but aren't
                #
                add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,X-Client-Version';
                #
                # Tell client that this pre-flight info is valid for 20 days
                #
                add_header 'Access-Control-Max-Age' 1728000;
                add_header 'Content-Type' 'text/plain; charset=utf-8';
                add_header 'Content-Length' 0;
                return 204;
             }
             if ($request_method = 'POST') {
                add_header 'Access-Control-Allow-Origin' 'https://bringyour.com' always;
                add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
                add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,X-Client-Version' always;
                add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range' always;
             }
             if ($request_method = 'GET') {
                add_header 'Access-Control-Allow-Origin' 'https://bringyour.com' always;
                add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
                add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,X-Client-Version' always;
                add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range' always;
             }
        }
    }
}